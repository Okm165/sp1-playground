name: Performance Main

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  benchmark:
    runs-on: warp-ubuntu-latest-arm64-16x
    env:
      CARGO_NET_GIT_FETCH_WITH_CLI: "true"
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2
        with:
          path: vm

      - name: Set up git private repo access
        run: |
          git config --global url."https://${{ secrets.PRIVATE_PULL_TOKEN }}@github.com/".insteadOf ssh://git@github.com
          git config --global url."https://${{ secrets.PRIVATE_PULL_TOKEN }}@github.com".insteadOf https://github.com

      - name: rust-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
            ~/.rustup/
          key: test-rust-nightly-2024-01-25-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: rust-nightly-2024-01-25-

      - name: Install nightly toolchain
        id: rustc-toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: nightly-2024-01-25
          override: true

      - name: Install cargo criterion
        run: cd vm && cargo install cargo-criterion --force

      - name: Cache main.json
        uses: actions/cache@v2
        with:
          path: vm/core/main.json
          key: perf-main-${{ github.sha }}

      - name: Run pr benchmark
        run: cd vm/core && cargo criterion --message-format=json --features perf > main.json && cat main.json
